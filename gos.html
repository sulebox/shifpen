<!DOCTYPE html>
<html>
<head>
    <title>3D Penguin Room</title>
    <style>body { margin: 0; } canvas { display: block; }</style>
</head>
<body>
    <script type="module">
        import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.167.1/build/three.module.js';
        import { GLTFLoader } from 'https://cdn.jsdelivr.net/npm/three@0.167.1/examples/jsm/loaders/GLTFLoader.js';
        import * as YUKA from 'https://unpkg.com/yuka@0.7.8/build/yuka.module.js'; // Updated to latest Yuka module

        // シーン、カメラ、レンダラー設定
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 10, 20); // 俯瞰視点（上から見下ろす）
        camera.lookAt(0, 0, 0); // 部屋中央を固定

        const renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // ライト追加
        const light = new THREE.DirectionalLight(0xffffff, 1);
        light.position.set(5, 10, 5);
        scene.add(light);

        // 部屋作成 (シンプル例)
        const floor = new THREE.Mesh(new THREE.PlaneGeometry(20, 20), new THREE.MeshBasicMaterial({color: 0xffd700}));
        floor.rotation.x = -Math.PI / 2;
        scene.add(floor);

        const shelf = new THREE.Mesh(new THREE.BoxGeometry(5, 3, 1), new THREE.MeshBasicMaterial({color: 0x8b4513}));
        shelf.position.set(5, 1.5, -9);
        scene.add(shelf);

        // 窓 (透明平面)
        const windowPane = new THREE.Mesh(new THREE.PlaneGeometry(4, 4), new THREE.MeshBasicMaterial({color: 0x87ceeb, transparent: true, opacity: 0.5}));
        windowPane.position.set(-9, 2, 0);
        windowPane.rotation.y = Math.PI / 2;
        scene.add(windowPane);

        // 玩具追加 (画像に基づくシンプル例)
        const toyFish = new THREE.Mesh(new THREE.SphereGeometry(0.5), new THREE.MeshBasicMaterial({color: 0xffa500}));
        toyFish.position.set(0, 0.5, 0);
        scene.add(toyFish);

        // ペンギンモデルロード 
        let mixer, penguin, actions = {}, currentAction;
        const loader = new GLTFLoader();
        loader.load('penguin.glb', (gltf) => {
            penguin = gltf.scene;
            scene.add(penguin);
            penguin.position.set(0, 0, 0);
            penguin.scale.set(1, 1, 1);

            // アニメーションミキサー設定 
            mixer = new THREE.AnimationMixer(penguin);
            const clips = gltf.animations;
            clips.forEach((clip) => {
                const action = mixer.clipAction(clip);
                actions[clip.name] = action; // アニメ名: idle, eat, play, walk, look
            });

            // 初期idle再生
            playAction('idle');

            // Yukaでランダム移動 (wander) 
            const entity = new YUKA.Vehicle();
            entity.setRenderComponent(penguin, sync); // 同期関数
            function sync(entity, renderComponent) {
                renderComponent.matrix.copy(entity.worldMatrix);
            }
            const wanderBehavior = new YUKA.WanderBehavior();
            entity.steering.add(wanderBehavior);

            const time = new YUKA.Time();
            const entityManager = new YUKA.EntityManager();
            entityManager.add(entity);

            // アニメーションランダムスイッチ
            setInterval(randomBehavior, 5000); // 5秒毎にランダム行動
        }, undefined, (error) => {
            console.error('Model loading error:', error); // エラーハンドリング追加
        });

        // 行動同期関数
        function playAction(name) {
            if (currentAction) currentAction.fadeOut(0.5);
            currentAction = actions[name];
            if (currentAction) currentAction.reset().fadeIn(0.5).play();
        }

        // ランダム行動  
        function randomBehavior() {
            const behaviors = ['idle', 'eat', 'play', 'walk', 'look'];
            const random = behaviors[Math.floor(Math.random() * behaviors.length)];
            playAction(random);

            // walk時はYuka wander有効化
            if (random === 'walk') {
                // wanderを強調 (オプションで調整可能)
            } else if (random === 'look') {
                if (penguin) penguin.lookAt(-9, 2, 0); // 窓方向
            }
        }

        // アニメーションループ
        const clock = new THREE.Clock();
        function animate() {
            requestAnimationFrame(animate);
            if (mixer) mixer.update(clock.getDelta());
            // Yuka更新
            if (typeof entityManager !== 'undefined') entityManager.update(time.update().getDelta());
            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>
